"use strict";var ie=Object.create;var $=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var h=(e,t)=>{for(var s in t)$(e,s,{get:t[s],enumerable:!0})},ce=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of de(t))!ue.call(e,o)&&o!==s&&$(e,o,{get:()=>t[o],enumerable:!(n=le(t,o))||n.enumerable});return e};var N=(e,t,s)=>(s=e!=null?ie(pe(e)):{},ce(t||!e||!e.__esModule?$(s,"default",{value:e,enumerable:!0}):s,e));var g=require("discord.js");var W=N(require("dotenv"));W.default.config();var{DISCORD_TOKEN:K,DISCORD_CLIENT_ID:z,DISCORD_JAM_CHANNEL_ID:he}=process.env;if(!K||!z)throw new Error("Missing environment variables");var Q={DISCORD_TOKEN:K,DISCORD_CLIENT_ID:z,DISCORD_JAM_CHANNEL_ID:he};var A={};h(A,{data:()=>Se,execute:()=>be});var D=require("discord.js");var v=N(require("fs")),Z=N(require("path"));var X={currentTheme:"",votingEndTime:"",jamStartTime:"",jamEndTime:"",jamPage:"",jamStage:"",votes:new Map,uservotes:[],themes:[],jamChannel:"",jamAdminRole:""};var E=Z.default.resolve(__dirname,"jamStates.json");v.default.existsSync(E)||v.default.writeFileSync(E,JSON.stringify({},null,2));var j=M();function fe(e){let t={};for(let[s,n]of Object.entries(e))t[s]={...n,votes:new Map(Object.entries(n.votes??{}))};return t}function ge(e){let t={};for(let[s,n]of Object.entries(e))t[s]={...n,votes:Object.fromEntries(n.votes??new Map)};return t}function M(){let e=JSON.parse(v.default.readFileSync(E,"utf-8"));return fe(e)}function ee(){let e=ge(j);v.default.writeFileSync(E,JSON.stringify(e,null,2))}function m(e){return j[e]||(j[e]=structuredClone(X),ee()),j[e]}function d(e){j[e]&&ee()}var Se=new D.SlashCommandBuilder().setName("theme").setDescription("shows the current jam theme");async function be(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let n=new D.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[n],flags:"Ephemeral"})}let s=new D.EmbedBuilder().setTitle("Current Theme").setDescription(`The current jam theme is ${t.currentTheme}`).setColor(16514816);await e.reply({embeds:[s],flags:"Ephemeral"})}var G={};h(G,{data:()=>Te,execute:()=>Ce});var S=require("discord.js");function B(e){let t=e.split(" "),s=t[1].split(":"),n=t[0].split(".");return`${n[0]}.${n[1]}.${n[2]} ${s[0]}:${s[1]}`}function we(e){let t=e.match(/^(\d{2})\.(\d{2})\.(\d{2}) (\d{2}):(\d{2})$/);if(!t)return null;let[s,n,o,r,i,a]=t,l=parseInt(r)+2e3;return new Date(l,parseInt(o)-1,parseInt(n),parseInt(i),parseInt(a))}function p(e){let t=we(e);if(!t)return"invalid time format";let s=new Date,n=t.getTime()-s.getTime();if(n<=0)return"past";let o=Math.floor(n/6e4),r=Math.floor(o/(24*60)),i=Math.floor(o%(24*60)/60),a=o%60;return`${r}d ${i}h ${a}m`}var Te=new S.SlashCommandBuilder().setName("timeleft").setDescription("Shows the time left till the end of the jam");async function Ce(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let s=new S.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage==""&&e.reply({content:"There is no on going Jam",flags:"Ephemeral"}),t.jamStage=="voting"){let s=p(t.votingEndTime);if(s=="past"){let n=new S.EmbedBuilder().setTitle("Voting start time").setDescription(`The voting has ended and the Jam will start at ${p(t.jamStartTime)}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new S.EmbedBuilder().setTitle("Voting end time").setDescription(`The Voting ends in ${s}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}if(t.jamStage=="voteEnd"){let s=p(t.jamStartTime);if(s=="past"){let n=new S.EmbedBuilder().setTitle("Jam start time").setDescription(`The the jam ends in ${p(t.jamEndTime)}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new S.EmbedBuilder().setTitle("Voting start time").setDescription(`The Jam starts in ${s}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}}var O={};h(O,{data:()=>ye,execute:()=>je});var b=require("discord.js");var ye=new b.SlashCommandBuilder().setName("jam").setDescription("shows the current Jam");async function je(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let s=new b.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage==""){let s=new b.EmbedBuilder().setTitle("Jam info").setDescription("There is no on going Jam").setColor(16514816);e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage=="voting"){let s=p(t.votingEndTime);if(s=="past"){let n=new b.EmbedBuilder().setTitle("Jam info").setDescription(`The voting has ended and the Jam will start at **${p(t.jamStartTime)}** the theme is **${t.currentTheme}**`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else e.reply({content:`The Voting ends in ${s}`,flags:"Ephemeral"})}if(t.jamStage=="voteEnd"){let s=p(t.jamStartTime);if(s=="past"){let n=new b.EmbedBuilder().setTitle("Jam info").setDescription(`The the jam ends in **${p(t.jamEndTime)}** the theme is **${t.currentTheme}**`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new b.EmbedBuilder().setTitle("Jam info").setDescription(`The Jam starts in **${s}** the theme still has to be voted`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}}var Y={};h(Y,{data:()=>ve,execute:()=>De});var u=require("discord.js");var ve=new u.SlashCommandBuilder().setName("createjam").setDescription("Create a Jam").addStringOption(e=>e.setName("votingenddate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jamstartdate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jamenddate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jampage").setDescription("The official page of the Jam").setRequired(!1));async function De(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let c=new u.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[c],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(c=>c.id===s)){let c=new u.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[c],flags:"Ephemeral"})}let o=e.options.getString("votingenddate",!0),r=e.options.getString("jamstartdate",!0),i=e.options.getString("jamenddate",!0),a=e.options.getString("jampage")??"";t.votingEndTime=B(o),t.jamStartTime=B(r),t.jamEndTime=B(i),t.jamPage=a;let l=t.themes;if(l.length==0){let c=new u.EmbedBuilder().setTitle("No themes available").setDescription("Please use /addtheme to add themes to the themepool").setColor(16716032);return e.reply({embeds:[c],flags:"Ephemeral"})}t.jamStage="voting",d(String(e.guildId));let w=[...l].sort(()=>Math.random()-.5).slice(0,3).map((c,Ye)=>new u.ButtonBuilder().setCustomId(`theme_vote_${c}`).setLabel(c).setStyle(u.ButtonStyle.Primary)),re=new u.ActionRowBuilder().addComponents(...w),me=new u.EmbedBuilder().setTitle("Vote for a Theme").setDescription(`## The Vote ends at **${t.votingEndTime}**`).setColor(7935),ae=new u.EmbedBuilder().setTitle("New Jam").setDescription("@everyone A New Jam has begun the Voting starts **now**").setColor(7935);await e.reply({embeds:[ae,me],components:[re]})}var q={};h(q,{data:()=>xe,execute:()=>Ie});var T=require("discord.js");var xe=new T.SlashCommandBuilder().setName("addtheme").setDescription("Add a new theme to the themepool").addStringOption(e=>e.setName("theme").setDescription("The theme you want in the theme pool").setRequired(!0));async function Ie(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let o=new T.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[o],flags:"Ephemeral"})}let s=e.options.getString("theme",!0);if(t.themes.includes(s)){let o=new T.EmbedBuilder().setTitle("Theme already exist").setDescription(`Your theme ${s} already exists`).setColor(16716032);e.reply({embeds:[o],flags:"Ephemeral"})}t.themes.push(s),d(String(e.guildId));let n=new T.EmbedBuilder().setTitle("Added theme").setDescription(`${e.user} added **${s}** to the themepool`).setColor(65416);return e.reply({embeds:[n]})}var _={};h(_,{data:()=>Ee,execute:()=>Be});var C=require("discord.js");var Ee=new C.SlashCommandBuilder().setName("deletejam").setDescription("Delete the current Jam");async function Be(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let r=new C.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[r],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(r=>r.id===s)){let r=new C.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[r],flags:"Ephemeral"})}t.currentTheme="",t.votingEndTime="",t.jamStartTime="",t.jamEndTime="",t.jamStage="",t.votes.clear(),t.uservotes=[],d(String(e.guildId));let o=new C.EmbedBuilder().setTitle("Jam was deled").setDescription(`The current Jam was deleted by ${e.user}`).setColor(65416).setTimestamp();e.reply({embeds:[o]})}var P={};h(P,{data:()=>Re,execute:()=>Je});var y=require("discord.js");var Re=new y.SlashCommandBuilder().setName("announcewinner").setDescription("Announce the winner of the Jam").addStringOption(e=>e.setName("submissioname").setDescription("The name of the winning submission").setRequired(!1)).addStringOption(e=>e.setName("submissionlink").setDescription("The link to the submission").setRequired(!1)).addStringOption(e=>e.setName("jamlink").setDescription("The link to the jam Participants").setRequired(!1)).addUserOption(e=>e.setName("winner").setDescription("The winner of the Jam").setRequired(!1)).addStringOption(e=>e.setName("stringwinner").setDescription("The winner of the Jam if he isn't on the Server").setRequired(!1));async function Je(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let w=new y.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[w],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(w=>w.id===s)){let w=new y.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[w],flags:"Ephemeral"})}let o=e.options.getString("submissioname",!0),r=e.options.getString("submissionlink",!0),i=e.options.getString("jamlink",!0),a=e.options.getUser("winner"),l=e.options.getString("stringwinner"),J;a?J=a:J=l;let F=new y.EmbedBuilder().setTitle("The Jam is over").setDescription(`The winner of the current Jam is...
# **${o}**
 ### check it out: **${r}**
 ### You can check out the other submissions at: **${i}**
 ### Congratulations to all participants! @everyone`).setColor(7935);await e.reply({embeds:[F]})}var k={};h(k,{data:()=>$e,execute:()=>Ne});var x=require("discord.js");var $e=new x.SlashCommandBuilder().setName("setup").setDescription("Setup of the jam bot").addChannelOption(e=>e.setName("jamchannel").setDescription("The channel that will recive updates about the current jam").setRequired(!0)).addRoleOption(e=>e.setName("jamadminrole").setDescription("The role required to create jams etc.").setRequired(!0));async function Ne(e){let t=m(String(e.guildId)),s=t.jamAdminRole;if(!e.member.roles.cache.some(a=>a.id===s)&&t.jamAdminRole!==""){let a=new x.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[a],flags:"Ephemeral"})}let o=e.options.getChannel("jamchannel",!0),r=e.options.getRole("jamadminrole",!0);t.jamChannel=String(o.id),t.jamAdminRole=String(r.id),d(String(e.guildId));let i=new x.EmbedBuilder().setTitle("Setup Complete").setDescription(`Your Jam channel is: **${o}**

             Your Jam-Admin role is: **${r}**

             If you want to change anything run /setup again

             

             have fun ;)`).setColor(65416);return e.reply({embeds:[i],flags:"Ephemeral"})}var V={};h(V,{data:()=>Me,execute:()=>Ae});var f=require("discord.js");var Me=new f.SlashCommandBuilder().setName("deletetheme").setDescription("Deletes one theme from the Themepool");async function Ae(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let l=new f.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[l],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(l=>l.id===s))return e.reply({content:"You don't have permission to run this command.",ephemeral:!0});if(t.themes.length==0){let l=new f.EmbedBuilder().setTitle("No themes available").setDescription("Add themes with `/addthemes`").setColor(16716032);e.reply({embeds:[l],flags:"Ephemeral"})}let o=new f.StringSelectMenuBuilder().setCustomId("delete_themes"),r=t.themes.map(l=>({label:l,value:l}));o.addOptions(r);let i=new f.ActionRowBuilder().addComponents(o),a=new f.EmbedBuilder().setTitle("Delete Theme").setDescription("Choose the theme you want to delete").setColor(16514816);e.reply({embeds:[a],components:[i],flags:"Ephemeral"})}var H={};h(H,{data:()=>Ge,execute:()=>Oe});var R=require("discord.js"),Ge=new R.SlashCommandBuilder().setName("help").setDescription("Shows a list of all commands");async function Oe(e){let t=new R.EmbedBuilder().setTitle("Help").setDescription("# User Commands:\n `/jam`: displayes the current theme and time left for jam\n `/timeleft`: displayes the time left for the jam to the user using the command\n `/theme`: displayes the current theme\n `/addtheme`: adds a new theme to the theme pool for the theme votes\n\n # Admin commands\n *These command can only be run by someone with the role specified with /setup*\n `/createjam`: creates a new Jam (there can only be one Jam at a time)\n `/deletejam`: deletes the current Jam\n `/announcewinner`: anounces the winner\n `/deletetheme`: deletes a them from the theme pool for the theme votings\n\n **Use `/setup` to setup the bot otherwise it wont work**").setColor(16514816);e.reply({embeds:[t],flags:"Ephemeral"})}var L={theme:A,timeleft:G,jam:O,createjam:Y,addtheme:q,deletejam:_,announcewinner:P,setup:k,deletetheme:V,help:H};var U=require("discord.js");async function te(e){let t=m(String(e.guildId)),s=e.user.id;if(!e.deferred&&!e.replied&&await e.deferReply({flags:"Ephemeral"}),t.uservotes.includes(s)){let n=new U.EmbedBuilder().setTitle("You cant vote").setDescription("You already voted").setColor(16514816);await e.editReply({embeds:[n]})}else{t.uservotes.push(s);let o=e.customId,r=t.votes.get(o)??0;t.votes.set(o,r+1);let i=e.customId.split("_").pop(),a=new U.EmbedBuilder().setTitle("You voted").setDescription(`You voted for ${i} as the next theme`).setColor(16514816);await e.editReply({embeds:[a]}),d(String(e.guildId))}}function ne(e){let t=m(e),s=-1,n=null;for(let[o,r]of t.votes.entries())r>s&&(s=r,n=o);return t.votes.clear(),t.uservotes=[],String(n)}var se=require("discord.js");async function oe(e){let t=m(String(e.guildId));!e.deferred&&!e.replied&&await e.deferReply({});let s=e.values[0],n=t.themes;t.themes=n.filter(r=>r!==s),d(String(e.guildId));let o=new se.EmbedBuilder().setTitle("Deleted theme").setDescription(`${e.user} deleted **${s}** from the theme-pool`).setColor(65416);await e.editReply({embeds:[o]})}var I=new g.Client({intents:[g.GatewayIntentBits.Guilds,g.GatewayIntentBits.GuildMessages,g.GatewayIntentBits.DirectMessages]});I.once("ready",async()=>{await I.application.commands.set([]),console.log("Discord bot is ready"),setInterval(async()=>{let e=M();for(let[t,s]of Object.entries(e)){let n=m(t),o=I.channels.cache.get(n.jamChannel);if(!n.jamChannel&&!o){console.log(`Channel not found for guild ${t}: ${n.jamChannel}`);continue}let r=n.jamChannel,i=n.jamStage;if(i=="voting"&&p(n.votingEndTime)=="past"){n.currentTheme=String(ne(t)),n.jamStage="voteEnd";let a=new g.EmbedBuilder().setTitle("Voting finished").setDescription(`The voting has ended the winner is: **${n.currentTheme}**`).setColor(7935).setTimestamp();if(!o)continue;await o.send({embeds:[a]})}if(i=="voteEnd"&&p(n.jamStartTime)=="past"){n.jamStage="jaming";let a=new g.EmbedBuilder().setTitle("Jam started").setDescription(`The the Jam started with the Theme: **${n.currentTheme}** 
 it ends on: **${n.jamEndTime}**`).setColor(7935).setTimestamp();if(!o)continue;await o.send({embeds:[a]})}if(i=="jaming"&&p(n.jamStartTime)=="past"){console.log("delete"),n.jamStage="";let a=new g.EmbedBuilder().setTitle("Jam ended").setDescription("The the Jam ended and the winner will be anounced shortly").setColor(7935).setTimestamp();if(n.currentTheme="",n.votingEndTime="",n.jamStartTime="",n.jamEndTime="",n.jamStage="",n.votes.clear(),n.uservotes=[],d(t),!o)continue;await o.send({embeds:[a]})}}},60*1e3)});I.on("interactionCreate",async e=>{if(e.isButton()){await te(e);return}if(e.isStringSelectMenu()){oe(e);return}let{commandName:t}=e;L[t]&&await L[t].execute(e)});I.login(Q.DISCORD_TOKEN);
