"use strict";var ue=Object.create;var M=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty;var h=(e,t)=>{for(var s in t)M(e,s,{get:t[s],enumerable:!0})},Se=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of fe(t))!ge.call(e,o)&&o!==s&&M(e,o,{get:()=>t[o],enumerable:!(n=ce(t,o))||n.enumerable});return e};var A=(e,t,s)=>(s=e!=null?ue(he(e)):{},Se(t||!e||!e.__esModule?M(s,"default",{value:e,enumerable:!0}):s,e));var u=require("discord.js");var X=A(require("dotenv"));X.default.config();var{DISCORD_TOKEN:Z,DISCORD_CLIENT_ID:ee}=process.env;if(!Z||!ee)throw new Error("Missing environment variables");var x={DISCORD_TOKEN:Z,DISCORD_CLIENT_ID:ee};var q={};h(q,{data:()=>we,execute:()=>Ce});var E=require("discord.js");var I=A(require("fs")),ne=A(require("path"));var te={currentTheme:"",votingEndTime:"",jamStartTime:"",jamEndTime:"",jamPage:"",jamStage:"",votes:new Map,uservotes:[],themes:[],jamChannel:"",jamAdminRole:""};var J=ne.default.resolve(__dirname,"jamStates.json");I.default.existsSync(J)||I.default.writeFileSync(J,JSON.stringify({},null,2));var C=O();function be(e){let t={};for(let[s,n]of Object.entries(e))t[s]={...n,votes:new Map(Object.entries(n.votes??{}))};return t}function Te(e){let t={};for(let[s,n]of Object.entries(e))t[s]={...n,votes:Object.fromEntries(n.votes??new Map)};return t}function O(){let e=JSON.parse(I.default.readFileSync(J,"utf-8"));return be(e)}function Y(){let e=Te(C);I.default.writeFileSync(J,JSON.stringify(e,null,2))}function se(e){delete C[e],Y()}function m(e){return C[e]||(C[e]=structuredClone(te),Y()),C[e]}function l(e){C[e]&&Y()}var we=new E.SlashCommandBuilder().setName("theme").setDescription("shows the current jam theme");async function Ce(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let n=new E.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[n],flags:"Ephemeral"})}let s=new E.EmbedBuilder().setTitle("Current Theme").setDescription(`The current jam theme is ${t.currentTheme}`).setColor(16514816);await e.reply({embeds:[s],flags:"Ephemeral"})}var _={};h(_,{data:()=>je,execute:()=>ve});var b=require("discord.js");function $(e){let t=e.split(" "),s=t[1].split(":"),n=t[0].split(".");return`${n[0]}.${n[1]}.${n[2]} ${s[0]}:${s[1]}`}function ye(e){let t=e.match(/^(\d{2})\.(\d{2})\.(\d{2}) (\d{2}):(\d{2})$/);if(!t)return null;let[s,n,o,r,i,a]=t,S=parseInt(r)+2e3;return new Date(S,parseInt(o)-1,parseInt(n),parseInt(i),parseInt(a))}function d(e){let t=ye(e);if(!t)return"invalid time format";let s=new Date,n=t.getTime()-s.getTime();if(n<=0)return"past";let o=Math.floor(n/6e4),r=Math.floor(o/(24*60)),i=Math.floor(o%(24*60)/60),a=o%60;return`${r}d ${i}h ${a}m`}var je=new b.SlashCommandBuilder().setName("timeleft").setDescription("Shows the time left till the end of the jam");async function ve(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let s=new b.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage==""&&e.reply({content:"There is no on going Jam",flags:"Ephemeral"}),t.jamStage=="voting"){let s=d(t.votingEndTime);if(s=="past"){let n=new b.EmbedBuilder().setTitle("Voting start time").setDescription(`The voting has ended and the Jam will start at ${d(t.jamStartTime)}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new b.EmbedBuilder().setTitle("Voting end time").setDescription(`The Voting ends in ${s}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}if(t.jamStage=="voteEnd"){let s=d(t.jamStartTime);if(s=="past"){let n=new b.EmbedBuilder().setTitle("Jam start time").setDescription(`The the jam ends in ${d(t.jamEndTime)}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new b.EmbedBuilder().setTitle("Voting start time").setDescription(`The Jam starts in ${s}`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}}var P={};h(P,{data:()=>De,execute:()=>xe});var T=require("discord.js");var De=new T.SlashCommandBuilder().setName("jam").setDescription("shows the current Jam");async function xe(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let s=new T.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage==""){let s=new T.EmbedBuilder().setTitle("Jam info").setDescription("There is no on going Jam").setColor(16514816);e.reply({embeds:[s],flags:"Ephemeral"})}if(t.jamStage=="voting"){let s=d(t.votingEndTime);if(s=="past"){let n=new T.EmbedBuilder().setTitle("Jam info").setDescription(`The voting has ended and the Jam will start at **${d(t.jamStartTime)}** the theme is **${t.currentTheme}**`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else e.reply({content:`The Voting ends in ${s}`,flags:"Ephemeral"})}if(t.jamStage=="voteEnd"){let s=d(t.jamStartTime);if(s=="past"){let n=new T.EmbedBuilder().setTitle("Jam info").setDescription(`The the jam ends in **${d(t.jamEndTime)}** the theme is **${t.currentTheme}**`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}else{let n=new T.EmbedBuilder().setTitle("Jam info").setDescription(`The Jam starts in **${s}** the theme still has to be voted`).setColor(16514816);e.reply({embeds:[n],flags:"Ephemeral"})}}}var k={};h(k,{data:()=>Ie,execute:()=>Ee});var p=require("discord.js");var Ie=new p.SlashCommandBuilder().setName("createjam").setDescription("Create a Jam").addStringOption(e=>e.setName("votingenddate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jamstartdate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jamenddate").setDescription("Th end date for the theme voting (DD.MM.YY HH:MM)").setRequired(!0)).addStringOption(e=>e.setName("jampage").setDescription("The official page of the Jam").setRequired(!1));async function Ee(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let f=new p.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[f],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(f=>f.id===s)){let f=new p.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[f],flags:"Ephemeral"})}let o=e.options.getString("votingenddate",!0),r=e.options.getString("jamstartdate",!0),i=e.options.getString("jamenddate",!0),a=e.options.getString("jampage")??"";t.votingEndTime=$(o),t.jamStartTime=$(r),t.jamEndTime=$(i),t.jamPage=a;let S=t.themes;if(S.length==0){let f=new p.EmbedBuilder().setTitle("No themes available").setDescription("Please use /addtheme to add themes to the themepool").setColor(16716032);return e.reply({embeds:[f],flags:"Ephemeral"})}t.jamStage="voting",l(String(e.guildId));let w=[...S].sort(()=>Math.random()-.5).slice(0,3).map((f,He)=>new p.ButtonBuilder().setCustomId(`theme_vote_${f}`).setLabel(f).setStyle(p.ButtonStyle.Primary)),le=new p.ActionRowBuilder().addComponents(...w),de=new p.EmbedBuilder().setTitle("Vote for a Theme").setDescription(`## The Vote ends at **${t.votingEndTime}**`).setColor(7935),pe=new p.EmbedBuilder().setTitle("New Jam").setDescription("@everyone A New Jam has begun the Voting starts **now**").setColor(7935);await e.reply({embeds:[pe,de],components:[le]})}var V={};h(V,{data:()=>Be,execute:()=>Re});var y=require("discord.js");var Be=new y.SlashCommandBuilder().setName("addtheme").setDescription("Add a new theme to the themepool").addStringOption(e=>e.setName("theme").setDescription("The theme you want in the theme pool").setRequired(!0));async function Re(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let o=new y.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[o],flags:"Ephemeral"})}let s=e.options.getString("theme",!0);if(t.themes.includes(s)){let o=new y.EmbedBuilder().setTitle("Theme already exist").setDescription(`Your theme ${s} already exists`).setColor(16716032);e.reply({embeds:[o],flags:"Ephemeral"})}t.themes.push(s),l(String(e.guildId));let n=new y.EmbedBuilder().setTitle("Added theme").setDescription(`${e.user} added **${s}** to the themepool`).setColor(65416);return e.reply({embeds:[n]})}var H={};h(H,{data:()=>Je,execute:()=>$e});var j=require("discord.js");var Je=new j.SlashCommandBuilder().setName("deletejam").setDescription("Delete the current Jam");async function $e(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let r=new j.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[r],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(r=>r.id===s)){let r=new j.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[r],flags:"Ephemeral"})}t.currentTheme="",t.votingEndTime="",t.jamStartTime="",t.jamEndTime="",t.jamStage="",t.votes.clear(),t.uservotes=[],l(String(e.guildId));let o=new j.EmbedBuilder().setTitle("Jam was deled").setDescription(`The current Jam was deleted by ${e.user}`).setColor(65416).setTimestamp();e.reply({embeds:[o]})}var L={};h(L,{data:()=>Ne,execute:()=>Ge});var v=require("discord.js");var Ne=new v.SlashCommandBuilder().setName("announcewinner").setDescription("Announce the winner of the Jam").addStringOption(e=>e.setName("submissioname").setDescription("The name of the winning submission").setRequired(!1)).addStringOption(e=>e.setName("submissionlink").setDescription("The link to the submission").setRequired(!1)).addStringOption(e=>e.setName("jamlink").setDescription("The link to the jam Participants").setRequired(!1)).addUserOption(e=>e.setName("winner").setDescription("The winner of the Jam").setRequired(!1)).addStringOption(e=>e.setName("stringwinner").setDescription("The winner of the Jam if he isn't on the Server").setRequired(!1));async function Ge(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let w=new v.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[w],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(w=>w.id===s)){let w=new v.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[w],flags:"Ephemeral"})}let o=e.options.getString("submissioname",!0),r=e.options.getString("submissionlink",!0),i=e.options.getString("jamlink",!0),a=e.options.getUser("winner"),S=e.options.getString("stringwinner"),c;a?c=a:c=S;let Q=new v.EmbedBuilder().setTitle("The Jam is over").setDescription(`The winner of the current Jam is...
# **${o}**
 ### check it out: **${r}**
 ### You can check out the other submissions at: **${i}**
 ### Congratulations to all participants! @everyone`).setColor(7935);await e.reply({embeds:[Q]})}var U={};h(U,{data:()=>Me,execute:()=>Ae});var B=require("discord.js");var Me=new B.SlashCommandBuilder().setName("setup").setDescription("Setup of the jam bot").addChannelOption(e=>e.setName("jamchannel").setDescription("The channel that will recive updates about the current jam").setRequired(!0)).addRoleOption(e=>e.setName("jamadminrole").setDescription("The role required to create jams etc.").setRequired(!0));async function Ae(e){let t=m(String(e.guildId)),s=t.jamAdminRole;if(!e.member.roles.cache.some(a=>a.id===s)&&t.jamAdminRole!==""){let a=new B.EmbedBuilder().setTitle("Invalid role").setDescription("You don't have permission to run this command.").setColor(16716032);return e.reply({embeds:[a],flags:"Ephemeral"})}let o=e.options.getChannel("jamchannel",!0),r=e.options.getRole("jamadminrole",!0);t.jamChannel=String(o.id),t.jamAdminRole=String(r.id),l(String(e.guildId));let i=new B.EmbedBuilder().setTitle("Setup Complete").setDescription(`Your Jam channel is: **${o}**

             Your Jam-Admin role is: **${r}**

             If you want to change anything run /setup again

             

             have fun ;)`).setColor(65416);return e.reply({embeds:[i],flags:"Ephemeral"})}var F={};h(F,{data:()=>Oe,execute:()=>Ye});var g=require("discord.js");var Oe=new g.SlashCommandBuilder().setName("deletetheme").setDescription("Deletes one theme from the Themepool");async function Ye(e){let t=m(String(e.guildId));if(t.jamAdminRole==""&&t.jamChannel==""){let c=new g.EmbedBuilder().setTitle("Bot isnt setup proprely").setDescription("Please use `/setup` to setup the bot properly").setColor(16716032);return e.reply({embeds:[c],flags:"Ephemeral"})}let s=t.jamAdminRole;if(!e.member.roles.cache.some(c=>c.id===s))return e.reply({content:"You don't have permission to run this command.",ephemeral:!0});if(t.themes.length==0){let c=new g.EmbedBuilder().setTitle("No themes available").setDescription("Add themes with `/addthemes`").setColor(16716032);e.reply({embeds:[c],flags:"Ephemeral"})}let o=new g.StringSelectMenuBuilder().setCustomId("delete_themes"),i=t.themes.sort().map(c=>({label:c,value:c}));o.addOptions(i);let a=new g.ActionRowBuilder().addComponents(o),S=new g.EmbedBuilder().setTitle("Delete Theme").setDescription("Choose the theme you want to delete").setColor(16514816);return e.reply({embeds:[S],components:[a],flags:"Ephemeral"})}var W={};h(W,{data:()=>qe,execute:()=>_e});var N=require("discord.js"),qe=new N.SlashCommandBuilder().setName("help").setDescription("Shows a list of all commands");async function _e(e){let t=new N.EmbedBuilder().setTitle("Help").setDescription("# User Commands:\n `/jam`: displayes the current theme and time left for jam\n `/timeleft`: displayes the time left for the jam to the user using the command\n `/theme`: displayes the current theme\n `/addtheme`: adds a new theme to the theme pool for the theme votes\n\n# Admin commands\n *These command can only be run by someone with the role specified with /setup*\n `/createjam`: creates a new Jam (there can only be one Jam at a time)\n `/deletejam`: deletes the current Jam\n `/announcewinner`: anounces the winner\n `/deletetheme`: deletes a them from the theme pool for the theme votings\n\n **Use `/setup` to setup the bot otherwise it wont work**").setColor(16514816);e.reply({embeds:[t],flags:"Ephemeral"})}var R={theme:q,timeleft:_,jam:P,createjam:k,addtheme:V,deletejam:H,announcewinner:L,setup:U,deletetheme:F,help:W};var G=require("discord.js");var Pe=Object.values(R).map(e=>e.data),ke=new G.REST({version:"10"}).setToken(x.DISCORD_TOKEN);async function K(e){try{console.log(`Started refreshing application (/) commands for guild: ${e}.`),await ke.put(G.Routes.applicationGuildCommands(x.DISCORD_CLIENT_ID,e),{body:Pe}),console.log(`Successfully reloaded application (/) commands for guild: ${e}.`)}catch(t){console.error(t)}}var z=require("discord.js");async function oe(e){let t=m(String(e.guildId)),s=e.user.id;if(!e.deferred&&!e.replied&&await e.deferReply({flags:"Ephemeral"}),t.uservotes.includes(s)){let n=new z.EmbedBuilder().setTitle("You cant vote").setDescription("You already voted").setColor(16514816);await e.editReply({embeds:[n]})}else{t.uservotes.push(s);let n=String(e.customId.split("_").pop()),o=t.votes.get(n)??0;t.votes.set(n,o+1);let r=e.customId.split("_").pop(),i=new z.EmbedBuilder().setTitle("You voted").setDescription(`You voted for ${r} as the next theme`).setColor(16514816);await e.editReply({embeds:[i]}),l(String(e.guildId))}}function re(e){let t=m(e),s=-1,n=null;for(let[o,r]of t.votes.entries())r>s&&(s=r,n=o);return t.votes.clear(),t.uservotes=[],l(e),String(n)}var me=require("discord.js");async function ae(e){let t=m(String(e.guildId));!e.deferred&&!e.replied&&await e.deferReply({});let s=e.values[0],n=t.themes;t.themes=n.filter(r=>r!==s),l(String(e.guildId));let o=new me.EmbedBuilder().setTitle("Deleted theme").setDescription(`${e.user} deleted **${s}** from the theme-pool`).setColor(65416);await e.editReply({embeds:[o]})}var ie={};var D=new u.Client({intents:[u.GatewayIntentBits.Guilds,u.GatewayIntentBits.GuildMessages,u.GatewayIntentBits.DirectMessages]});D.once("ready",async()=>{for(let e in ie)K(e);console.log("Discord bot is ready"),setInterval(async()=>{let e=O();for(let[t,s]of Object.entries(e)){let n=m(t),o=D.channels.cache.get(n.jamChannel);if(!n.jamChannel&&!o){console.log(`Channel not found for guild ${t}: ${n.jamChannel}`);continue}let r=n.jamChannel,i=n.jamStage;if(i=="voting"&&d(n.votingEndTime)=="past"){n.currentTheme=String(re(t)),n.jamStage="voteEnd";let a=new u.EmbedBuilder().setTitle("Voting finished").setDescription(`The voting has ended the winner is: **${n.currentTheme}**`).setColor(7935).setTimestamp();if(!o)continue;await o.send({embeds:[a]})}if(i=="voteEnd"&&d(n.jamStartTime)=="past"){n.jamStage="jaming";let a=new u.EmbedBuilder().setTitle("Jam started").setDescription(`The the Jam started with the Theme: **${n.currentTheme}** 
 it ends on: **${n.jamEndTime}**`).setColor(7935).setTimestamp();if(!o)continue;await o.send({embeds:[a]})}if(i=="jaming"&&d(n.jamStartTime)=="past"){console.log("delete"),n.jamStage="";let a=new u.EmbedBuilder().setTitle("Jam ended").setDescription("The the Jam ended and the winner will be anounced shortly").setColor(7935).setTimestamp();if(n.currentTheme="",n.votingEndTime="",n.jamStartTime="",n.jamEndTime="",n.jamStage="",n.votes.clear(),n.uservotes=[],l(t),!o)continue;await o.send({embeds:[a]})}}},60*1e3)});D.on(u.Events.GuildCreate,async e=>{K(e.id)});D.on(u.Events.GuildDelete,async e=>{se(e.id)});D.on("interactionCreate",async e=>{if(e.isButton()){await oe(e);return}if(e.isStringSelectMenu()){ae(e);return}let{commandName:t}=e;R[t]&&await R[t].execute(e)});D.login(x.DISCORD_TOKEN);
